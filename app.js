// v5: WhatsApp/Facebook share + no color animations + written dictation + improved Kahoot + DnD
let voices=[];function loadVoices(){voices=speechSynthesis.getVoices()}window.speechSynthesis?.addEventListener('voiceschanged',loadVoices);loadVoices();
function speak(t,rate=0.8){if(!('speechSynthesis'in window)){return}const u=new SpeechSynthesisUtterance(t);const v=voices.find(v=>/en-GB/i.test(v.lang)&&/Google UK English Female|Hazel|Liberty/i.test(v.name))||voices.find(v=>/en-GB/i.test(v.lang))||voices[0];if(v)u.voice=v;u.rate=rate;u.pitch=1;speechSynthesis.cancel();speechSynthesis.speak(u)}

// Sounds only (no visual confetti)
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();function beep(type='ok'){const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);o.frequency.value=type==='ok'?880:260;g.gain.value=0.05;o.type='square';o.start();setTimeout(()=>o.stop(),170)}function cheer(){const dur=0.5;const sr=audioCtx.sampleRate;const len=sr*dur;const buffer=audioCtx.createBuffer(1,len,sr);const data=buffer.getChannelData(0);for(let i=0;i<len;i++){data[i]=(Math.random()*2-1)*Math.exp(-3*i/len);}const src=audioCtx.createBufferSource();src.buffer=buffer;const g=audioCtx.createGain();g.gain.value=0.15;src.connect(g);g.connect(audioCtx.destination);src.start();setTimeout(()=>{beep('ok');},150)}

// Toast helper
function showToast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),1800)}

// Share buttons (WhatsApp & Facebook)
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('waShare')?.addEventListener('click',()=>{
    const url=encodeURIComponent(location.href);
    const text=encodeURIComponent(document.title+' '+location.href);
    const link=`https://wa.me/?text=${text}`;
    window.open(link,'_blank');
  });
  document.getElementById('fbShare')?.addEventListener('click',()=>{
    const url=encodeURIComponent(location.href);
    const link=`https://www.facebook.com/sharer/sharer.php?u=${url}`;
    window.open(link,'_blank');
  });
});

// Data (same as previous)
const data={lessons:{1:{title:'Lesson 1 â€” Go Green',vocabulary:[{en:'concerns',ar:'Ù…Ø®Ø§ÙˆÙ',ex:'There are concerns about pollution.'},{en:'slogan',ar:'Ø´Ø¹Ø§Ø±',ex:'The campaign uses a simple slogan.'},{en:'depletion',ar:'Ø§Ø³ØªÙ†Ø²Ø§Ù',ex:'Depletion of resources is a serious issue.'},{en:'landfills',ar:'Ù…ÙƒØ¨Ø§Øª Ø§Ù„Ù†ÙØ§ÙŠØ§Øª',ex:'Recycling reduces waste in landfills.'},{en:'renewable energy',ar:'Ø·Ø§Ù‚Ø© Ù…ØªØ¬Ø¯Ø¯Ø©',ex:'Solar power is renewable energy.'},{en:'eco-friendly',ar:'ØµØ¯ÙŠÙ‚ Ù„Ù„Ø¨ÙŠØ¦Ø©',ex:'We prefer eco-friendly products.'},{en:'recycle',ar:'ÙŠÙØ¹ÙŠØ¯ Ø§Ù„ØªØ¯ÙˆÙŠØ±',ex:'We recycle paper and plastic.'},{en:'reuse',ar:'ÙŠÙØ¹ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…',ex:'Reuse bottles to cut waste.'},{en:'global warming',ar:'Ø§Ù„Ø§Ø­ØªØ¨Ø§Ø³ Ø§Ù„Ø­Ø±Ø§Ø±ÙŠ',ex:'Global warming is a global concern.'},{en:'initiative',ar:'Ù…Ø¨Ø§Ø¯Ø±Ø©',ex:'Students started a green initiative.'},{en:'resources',ar:'Ù…ÙˆØ§Ø±Ø¯',ex:'Natural resources must be protected.'},{en:'pollution',ar:'ØªÙ„ÙˆØ«',ex:'Factories should reduce pollution.'},{en:'reduce',ar:'ÙŠÙ‚Ù„Ù„',ex:'We reduce waste by recycling.'},{en:'manufacturing',ar:'Ø§Ù„ØªØµÙ†ÙŠØ¹',ex:'Green manufacturing saves energy.'},{en:'sustainable',ar:'Ù…Ø³ØªØ¯Ø§Ù…',ex:'Sustainable practices help the future.'}],reading:['Factories caused air and water pollution in the past.','Going green means making eco-friendly changes.','Green manufacturing uses renewable energy and clean technology.','Companies try to reduce waste and reuse materials.','Global warming is a serious concern for the world.','Working together can build a sustainable future.'],readingMCQ:[{q:'"Going green" mostly meansâ€¦',opts:['painting factories green','making eco-friendly changes','using more vehicles','avoiding technology'],a:1},{q:'Renewable energy helps preventâ€¦',opts:['depletion of resources','global warming','landfills','campaigns'],a:0},{q:'One aim of green manufacturing is toâ€¦',opts:['increase waste','reuse materials','use more natural resources','focus on profits only'],a:1},{q:'Global warming is aâ€¦',opts:['local rule','minor issue','major concern','new slogan'],a:2}]},2:{title:'Lesson 2 â€” One Bag at a Time',vocabulary:[{en:'reusable',ar:'Ù‚Ø§Ø¨Ù„ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…',ex:'Use reusable bags many times.'},{en:'campaign',ar:'Ø­Ù…Ù„Ø©',ex:'The town started a clean-up campaign.'},{en:'waste',ar:'Ù†ÙØ§ÙŠØ§Øª / ÙŠÙ‡Ø¯Ø±',ex:'We must reduce plastic waste.'},{en:'reduce',ar:'ÙŠÙ‚Ù„Ù„',ex:'Reduce plastic to keep areas clean.'},{en:'swap',ar:'ÙŠØ³ØªØ¨Ø¯Ù„',ex:'People swap old bags for new ones.'},{en:'community',ar:'Ù…Ø¬ØªÙ…Ø¹',ex:'The community supports the project.'},{en:'alternative',ar:'Ø¨Ø¯ÙŠÙ„',ex:'Cloth bags are a good alternative.'},{en:'volunteer',ar:'Ù…ØªØ·ÙˆØ¹',ex:'Volunteers helped the campaign.'},{en:'Bag Swap Day',ar:'ÙŠÙˆÙ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨',ex:'Families enjoyed Bag Swap Day.'},{en:'local shops',ar:'Ø§Ù„Ù…Ø­Ø§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠØ©',ex:'Local shops reduced plastic use.'}],reading:['Ahmed planned a campaign to reduce plastic use.','He explained why reusable bags are better.','The campaign organized a fun Bag Swap Day.','Many local shops joined the campaign.','Families enjoyed the event and supported change.','The area became cleaner after the campaign.'],readingMCQ:[{q:'Reusable bags are better because theyâ€¦',opts:['are fashionable','can be used many times','are made of plastic','are expensive'],a:1},{q:'The event that made the campaign fun wasâ€¦',opts:['a discount day','a Bag Swap Day','a picnic','a quiz'],a:1},{q:'Which happened after the campaign?',opts:['shops closed','more shops stopped using plastic','bags got expensive','people stopped shopping'],a:1},{q:'The campaignâ€™s main goal was toâ€¦',opts:['promote new shops','reduce plastic use','ask for money','describe recycling paper'],a:1}]},3:{title:'Lesson 3 â€” Small Actions Can Make a Difference',vocabulary:[{en:'turn off',ar:'ÙŠÙØ·ÙØ¦',ex:'Turn off lights when leaving.'},{en:'unplug',ar:'ÙŠÙØµÙ„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡',ex:'Unplug devices to save energy.'},{en:'plant trees',ar:'ÙŠØ²Ø±Ø¹ Ø§Ù„Ø£Ø´Ø¬Ø§Ø±',ex:'Plant trees to clean the air.'},{en:'walk or cycle',ar:'ÙŠÙ…Ø´ÙŠ Ø£Ùˆ ÙŠØ±ÙƒØ¨ Ø¯Ø±Ø§Ø¬Ø©',ex:'Walk or cycle to reduce pollution.'},{en:'save energy',ar:'ÙŠÙˆÙØ± Ø§Ù„Ø·Ø§Ù‚Ø©',ex:'Saving energy protects the planet.'},{en:'avoid',ar:'ÙŠØªØ¬Ù†Ø¨',ex:'Avoid using harmful chemicals.'},{en:'prefer',ar:'ÙŠÙÙØ¶Ù‘Ù„',ex:'I prefer reusable products.'},{en:'begin',ar:'ÙŠØ¨Ø¯Ø£',ex:'We begin a green project soon.'}],reading:['Simple habits protect the environment every day.','Turn off lights and unplug devices to save energy.','Planting trees gives us fresh air.','Walking or cycling reduces pollution.','Working together creates a cleaner future.','Small actions make a big difference.'],readingMCQ:[{q:'Saving energy can be done byâ€¦',opts:['using more lights','unplugging devices','driving more','burning plastic'],a:1},{q:'Planting trees makes the airâ€¦',opts:['polluted','fresh','dirty','limited'],a:1},{q:'Walking or cycling helps toâ€¦',opts:['increase waste','reduce pollution','use more chemicals','stop recycling'],a:1},{q:'Small actions can have a bigâ€¦',opts:['impact','problem','landfill','concern'],a:0}],grammarRule:'Verbs + infinitive or -ing (Gerunds)\nâ€¢ Verbs with -ing: enjoy, avoid, suggest.\nâ€¢ Verbs with to + infinitive: decide, plan, agree, hope, want.\nâ€¢ Both (meaning changes): remember, stop, try, begin/start.',grammarMCQ:[{q:'She enjoys ____ music.',opts:['to listen','listening','listen','to listening'],a:1},{q:'He promised ____ me with the project.',opts:['helping','to help','help','to helping'],a:1},{q:'They avoid ____ junk food.',opts:['eating','eat','to eating','to eat'],a:0},{q:'We decided ____ a new car.',opts:['buying','to buying','to buy','buy'],a:2},{q:'Please remember ____ off the lights before leaving.',opts:['turning','to turn','turn','to turning'],a:1},{q:'She suggested ____ a break.',opts:['to take','take','taking','to taking'],a:2},{q:'He stopped ____ a coffee break.',opts:['taking','to take','take','to taking'],a:0},{q:'I\'ll never forget ____ the Eiffel Tower for the first time.',opts:['to see','seeing','see','to seeing'],a:1},{q:'Nada agreed ____ to the party.',opts:['come','to come','coming','to coming'],a:1},{q:'We plan ____ a campaign to protect nature.',opts:['start','to start','starting','to starting'],a:1}]},4:{title:'Lesson 4 â€” Helping our community',vocabulary:[{en:'survey',ar:'ÙŠÙŽÙ…Ø³ÙŽØ­/ÙŠØ³ØªÙ‚ØµÙŠ',ex:'The team will survey water sources.'},{en:'leak',ar:'ØªØ³Ø±Ù‘Ø¨',ex:'A small leak wastes many liters of water.'},{en:'record',ar:'ÙŠÙØ³Ø¬Ù„',ex:'They record observations in notebooks.'},{en:'assembly',ar:'Ø§Ù„Ø·Ø§Ø¨ÙˆØ±/Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©',ex:'Ideas were shared at the school assembly.'},{en:'impact',ar:'ØªØ£Ø«ÙŠØ± ÙƒØ¨ÙŠØ±',ex:'Small actions can have a big impact.'},{en:'tap',ar:'ØµÙ†Ø¨ÙˆØ±',ex:'Turn off taps after washing.'},{en:'fountain',ar:'Ù†Ø§ÙÙˆØ±Ø© Ù…ÙŠØ§Ù‡',ex:'Check the water fountain for leaks.'},{en:'save water',ar:'ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø§Ø¡',ex:'Using bottles helps save water.'}],reading:['Students formed a Water Team to save water at school.','They surveyed taps and fountains for drips and leaks.','The team recorded their observations in notebooks.','They presented ideas at the school assembly.','Other classes began to save water too.','Small changes made a big impact on the community.'],readingMCQ:[{q:'The Water Team\'s first task was toâ€¦',opts:['plant trees','check water sources for leaks','clean the lab','collect rainwater'],a:1},{q:'Fixing small leaks is important because itâ€¦',opts:['saves paper cups','prevents wasting water','cleans chairs','looks better'],a:1},{q:'At the assembly, they sharedâ€¦',opts:['games','photos and ideas','a play','bottles of water'],a:1},{q:'The story shows that small actions can have a bigâ€¦',opts:['impact','problem','landfill','slogan'],a:0}]}},exam:[{q:'We must ____ the environment from pollution.',opts:['protect','pollute','ignore','waste'],a:0},{q:'Factories should reduce air ____.',opts:['pollution','energy','recycle','climate'],a:0},{q:'Solar power is a form of ____ energy.',opts:['renewable','waste','harmful','limited'],a:0},{q:'We need to ____ water to save resources.',opts:['conserve','throw','spend','waste'],a:0},{q:'People should ____ plastic to protect nature.',opts:['recycle','burn','ignore','pollute'],a:0},{q:'Global warming affects the world\'s ____.',opts:['climate','waste','energy','pollution'],a:0},{q:'Using ____ products helps the planet.',opts:['eco-friendly','harmful','dirty','toxic'],a:0},{q:'We must reduce ____ to keep our cities clean.',opts:['waste','energy','climate','resources'],a:0},{q:'Wind and solar are ____ sources of energy.',opts:['renewable','limited','harmful','toxic'],a:0},{q:'Planting trees helps to fight air ____.',opts:['pollution','recycle','energy','climate'],a:0},{q:'She decided ____ a new eco-friendly car.',opts:['buy','to buy','buying','to buying'],a:1},{q:'He enjoys ____ about saving energy.',opts:['talk','to talk','talking','to talking'],a:2},{q:'We plan ____ a campaign to protect nature.',opts:['start','to start','starting','to starting'],a:1},{q:'They suggested ____ plastic waste.',opts:['reduce','to reduce','reducing','to reducing'],a:2},{q:'I want ____ more about recycling.',opts:['learn','to learn','learning','to learning'],a:1},{q:'She avoided ____ harmful chemicals.',opts:['use','to use','using','to using'],a:2},{q:'We hope ____ a green project soon.',opts:['begin','to begin','beginning','to beginning'],a:1},{q:'He finished ____ the article on global warming.',opts:['read','to read','reading','to reading'],a:2},{q:'They agreed ____ the meeting about sustainability.',opts:['attend','to attend','attending','to attending'],a:1},{q:'She likes ____ trees in her garden.',opts:['plant','to plant','planting','to planting'],a:2}]};

function $(s,r=document){return r.querySelector(s)}function $all(s,r=document){return Array.from(r.querySelectorAll(s))}
function buildTopTabs(){const w=$('.tabs');['Lesson 1','Lesson 2','Lesson 3','Lesson 4','Unit Exam'].forEach((t,i)=>{const el=document.createElement('div');el.className='tab';el.textContent=t;el.onclick=()=>activateSection(i);w.appendChild(el)})}
function activateSection(i){$all('.tab').forEach((t,idx)=>t.classList.toggle('active',idx===i));$all('.section').forEach((s,idx)=>s.classList.toggle('active',idx===i))}
function buildLesson(n){const sec=document.createElement('div');sec.className='section';const subt=document.createElement('div');subt.className='subtabs';sec.appendChild(subt);const content=document.createElement('div');content.className='lesson-content';sec.appendChild(content);const labels=['Vocabulary','Games','Reading'];if(n===3)labels.push('Grammar');labels.forEach((st,idx)=>{const s=document.createElement('div');s.className='subtab';s.textContent=st;s.onclick=()=>activateSub(content,subt,n,idx);subt.appendChild(s)});document.querySelector('.container').appendChild(sec);activateSub(content,subt,n,0)}
function activateSub(content,subtabs,n,idx){$all('.subtab',subtabs).forEach((t,i)=>t.classList.toggle('active',i===idx));content.innerHTML='';const L=data.lessons[n];if(idx===0)renderVocab(content,L.vocabulary);else if(idx===1)renderGames(content,L.vocabulary,n);else if(idx===2)renderReading(content,L.reading,L.readingMCQ);else renderGrammar(content,data.lessons[3].grammarRule,data.lessons[3].grammarMCQ)}

// Vocabulary view + Listening Practice + Written Dictation
function renderVocab(root,vocab){
  const colors=['linear-gradient(135deg,#fff9c4,#ffeaa7)','linear-gradient(135deg,#ffecb3,#ffd54f)','linear-gradient(135deg,#ffe082,#ffcc80)','linear-gradient(135deg,#fff9c4,#ffd54f)','linear-gradient(135deg,#fff9c4,#a7d8f0)'];
  const grid=document.createElement('div');grid.className='cards';root.appendChild(grid);
  vocab.forEach((item,idx)=>{const c=document.createElement('div');c.className='card';c.style.background=colors[idx%colors.length];c.innerHTML=`<h3>${item.en}</h3><div class="ar">${item.ar}</div><div class="ex">Example: ${item.ex}</div>`;const btns=document.createElement('div');btns.className='btns';const b1=document.createElement('button');b1.className='btn';b1.textContent='ðŸ”Š Word';b1.onclick=()=>speak(item.en);const b2=document.createElement('button');b2.className='btn secondary';b2.textContent='ðŸ”Š Example';b2.onclick=()=>speak(item.ex);btns.appendChild(b1);btns.appendChild(b2);c.appendChild(btns);grid.appendChild(c)});

  // Listening Practice (Arabic -> English audio)
  const tools=document.createElement('div');tools.className='qcard';tools.style.background='#fff9e1';tools.style.border='1px solid #f3d370';tools.style.marginTop='10px';
  tools.innerHTML=`<b>Listening Practice:</b> Show Arabic, hear English.<br>
  <div id="lpBox" style="margin-top:8px;padding:12px;border-radius:12px;background:linear-gradient(135deg,#fffbea,#fff3c4);border:1px dashed #f3d370;text-align:center;font-size:18px;font-weight:700;color:#6b4a00">Ready?</div>
  <div class="btns"><button class="btn small" id="lpStart">Start</button><button class="btn small secondary" id="lpRepeat">Repeat</button><button class="btn small warning" id="lpNext">Next</button></div>`;
  root.appendChild(tools);
  let order=[...vocab].sort(()=>Math.random()-0.5), idx=0; const box=tools.querySelector('#lpBox');
  function lpShow(){if(idx>=order.length){box.textContent='Great job!';cheer();return}box.textContent=order[idx].ar;speak(order[idx].en,0.8)}
  tools.querySelector('#lpStart').onclick=()=>{idx=0;lpShow()};
  tools.querySelector('#lpRepeat').onclick=()=>{if(idx<order.length){speak(order[idx].en,0.8)}};
  tools.querySelector('#lpNext').onclick=()=>{cheer();idx++;lpShow()};

  // Written Dictation (Arabic -> type English)
  const dict=document.createElement('div');dict.className='qcard';dict.style.marginTop='10px';dict.style.background='#fff9e6';dict.style.border='1px solid #f3d370';
  dict.innerHTML=`<b>Written Dictation:</b> Type the English word for the shown Arabic. With applause on correct.<br>
  <div id="dStats" style="margin-top:6px;color:#6b4a00">Score: <span id="dOK">0</span>/<span id="dTotal">0</span> Â· Wrong queue: <span id="dWrong">0</span></div>
  <div id="dArea" style="margin-top:8px"></div>
  <div class="btns"><button class="btn small" id="dStart">Start</button> <button class="btn small" id="dStop">Stop</button></div>`;root.appendChild(dict);
  let dRun=false, dIndex=0, dOrder=[], wrong=[];const dArea=dict.querySelector('#dArea');
  function dUpdate(){dict.querySelector('#dTotal').textContent=String(dOrder.length);dict.querySelector('#dWrong').textContent=String(wrong.length)}
  function dAsk(){if(!dRun)return;dUpdate();if(dIndex>=dOrder.length){if(wrong.length){dOrder=wrong;wrong=[];dIndex=0;showToast('Review wrong answers');}else{showToast('Dictation finished âœ…');dRun=false;return}}const item=dOrder[dIndex];dArea.innerHTML=`<div><b>Arabic:</b> <span style=\"color:#c27c00\">${item.ar}</span></div><input id=\"dInput\" style=\"width:100%;padding:10px;margin-top:8px;border-radius:10px;border:1px solid #f3d370\" placeholder=\"Type English...\"/><div class=\"btns\"><button class=\"btn\" id=\"dCheck\">Check</button> <button class=\"btn secondary\" id=\"dRepeat\">Repeat word</button></div>`;speak(item.en);document.getElementById('dCheck').onclick=()=>{const val=document.getElementById('dInput').value.trim().toLowerCase();const target=item.en.toLowerCase();if(val===target){cheer();document.getElementById('dOK').textContent=String(Number(document.getElementById('dOK').textContent)+1);dIndex++;dAsk()}else{beep('bad');wrong.push(item);dIndex++;dAsk()}};document.getElementById('dRepeat').onclick=()=>speak(item.en)}
  dict.querySelector('#dStart').onclick=()=>{dRun=true;dOrder=[...vocab].sort(()=>Math.random()-0.5);dIndex=0;wrong=[];document.getElementById('dOK').textContent='0';dAsk()};
  dict.querySelector('#dStop').onclick=()=>{dRun=false;dArea.innerHTML=''}
}

// Games
function renderGames(root,vocab){const wrap=document.createElement('div');root.appendChild(wrap);wrap.innerHTML=`<h3>Card Matching (Drag & Drop or Tap)</h3>`;const board=document.createElement('div');board.className='board';wrap.appendChild(board);const left=document.createElement('div');left.className='pair';board.appendChild(left);const right=document.createElement('div');right.className='pair';board.appendChild(right);const shuffled=[...vocab].sort(()=>Math.random()-0.5).slice(0,6);shuffled.forEach(item=>{const dz=document.createElement('div');dz.className='dropzone';dz.dataset.target=item.en.toLowerCase();dz.textContent=item.ar;left.appendChild(dz)});const words=shuffled.map(i=>i.en);words.sort(()=>Math.random()-0.5).forEach(w=>{const dr=document.createElement('div');dr.className='draggable';dr.draggable=true;dr.textContent=w;dr.dataset.word=w.toLowerCase();right.appendChild(dr);dr.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',dr.dataset.word)});dr.addEventListener('touchstart',()=>{toggleSelect(dr)})});$all('.dropzone',left).forEach(dz=>{dz.addEventListener('dragover',e=>e.preventDefault());dz.addEventListener('drop',e=>{const w=e.dataTransfer.getData('text/plain');checkMatch(dz,w)});dz.addEventListener('click',()=>{const sel=$('.draggable.selected',right);if(sel)checkMatch(dz,sel.dataset.word)})});function checkMatch(dz,w){if(!w)return;if(w===dz.dataset.target){dz.style.background='#edfff0';dz.style.borderColor='#8fe09a';dz.textContent=dz.textContent+'  âœ“';const sel=$('.draggable.selected',right);sel?.remove();cheer()}else{dz.style.background='#fff1f0';dz.style.borderColor='#ff9aa2';beep('bad')}}function toggleSelect(el){$all('.draggable',right).forEach(e=>e.classList.remove('selected'));el.classList.add('selected')}

  // Dual Kahoot
  const quiz=document.createElement('div');quiz.className='quiz';wrap.appendChild(quiz);
  quiz.appendChild(buildKahoot(vocab,'AR2EN'));
  quiz.appendChild(buildKahoot(vocab,'EN2AR'));
}

function buildKahoot(vocab,mode='AR2EN'){const card=document.createElement('div');card.className='qcard';card.style.background='linear-gradient(135deg,#fffbea,#fff3c4)';const q=document.createElement('div');const ops=document.createElement('div');card.appendChild(document.createElement('h3')).textContent=(mode==='AR2EN'?'Kahoot: Choose the English word':'Kahoot: Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù†Ù‰ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ');card.appendChild(q);card.appendChild(ops);card.appendChild(Object.assign(document.createElement('div'),{className:'progress',innerHTML:'<div class="bar"></div>'}));const bank=[...vocab].sort(()=>Math.random()-0.5).slice(0,8);let i=0,score=0;function ask(){const it=bank[i];let correct,pool;if(mode==='AR2EN'){q.innerHTML=`Meaning: <b style="color:#7a5a00">${it.ar}</b>`;correct=it.en;pool=vocab.map(v=>v.en)}else{q.innerHTML=`Word: <b style="color:#7a5a00">${it.en}</b>`;correct=it.ar;pool=vocab.map(v=>v.ar)}const set=new Set([correct]);while(set.size<4){set.add(pool[Math.floor(Math.random()*pool.length)])}const arr=[...set].sort(()=>Math.random()-0.5);ops.innerHTML='';arr.forEach(opt=>{const el=document.createElement('div');el.className='option';el.textContent=opt;el.onclick=()=>{if(opt===correct){el.classList.add('correct');score++;cheer()}else{el.classList.add('wrong');beep('bad')}setTimeout(()=>{i++;card.querySelector('.bar').style.width=((i)/bank.length*100)+'%';if(i<bank.length)ask();else q.innerHTML=`Finished! Score: ${score}/${bank.length}`},450)};ops.appendChild(el)})}ask();return card}

function renderReading(root,sentences,mcq){const list=document.createElement('div');root.appendChild(list);sentences.forEach((s,i)=>{const el=document.createElement('div');el.className='sentence';el.innerHTML=`<div>${i+1}. ${s}</div><div class="btns"><button class="btn small">ðŸ”Š Play</button></div>`;$('button',el).onclick=()=>speak(s,0.8);list.appendChild(el)});const quiz=document.createElement('div');quiz.className='mcq';root.appendChild(quiz);quiz.innerHTML=`<h3>Vocabulary Check (MCQ)</h3>`;mcq.forEach((it,i)=>{const card=document.createElement('div');card.className='qcard';card.style.background=['#fff9e6','#fff3c4','#ffecb3','#ffeaa7','#ffcc80'][i%5];const opts=it.opts.map((o,idx)=>`<div class="option" data-i="${idx}">${o}</div>`).join('');card.innerHTML=`<div>${i+1}. ${it.q}</div>${opts}`;quiz.appendChild(card);$all('.option',card).forEach(op=>op.onclick=()=>{const idx=Number(op.dataset.i);if(idx===it.a){op.classList.add('correct');cheer()}else{op.classList.add('wrong');beep('bad')}})})}

function renderGrammar(root,rule,bank){const box=document.createElement('div');box.className='rule';box.textContent=rule;root.appendChild(box);const quiz=document.createElement('div');quiz.className='mcq';root.appendChild(quiz);quiz.innerHTML=`<h3>Grammar Practice: Choose the correct form</h3>`;bank.forEach((it,i)=>{const card=document.createElement('div');card.className='qcard';card.style.background=['#fff9e6','#fff3c4','#ffecb3','#ffeaa7','#ffcc80'][i%5];const opts=it.opts.map((o,idx)=>`<div class="option" data-i="${idx}">${o}</div>`).join('');card.innerHTML=`<div>${i+1}. ${it.q}</div>${opts}`;quiz.appendChild(card);$all('.option',card).forEach(op=>op.onclick=()=>{const idx=Number(op.dataset.i);if(idx===it.a){op.classList.add('correct');cheer()}else{op.classList.add('wrong');beep('bad')}})})}

function renderExam(){const sec=document.createElement('div');sec.className='section';document.querySelector('.container').appendChild(sec);const head=document.createElement('div');head.className='exam-header';head.innerHTML=`<b>Unit 4 â€” Save & Shine</b><br>Interactive MCQ Exam (English-only instructions)`;sec.appendChild(head);const box=document.createElement('div');box.className='mcq';sec.appendChild(box);const colors=['#fff9e6','#fff3c4','#ffecb3','#ffeaa7','#ffcc80'];let i=0,score=0;function ask(){box.innerHTML='';const it=data.exam[i];const card=document.createElement('div');card.className='qcard';card.style.background=colors[i%colors.length];card.style.border='1px solid #f3d370';card.innerHTML=`<div>${i+1}/${data.exam.length}. ${it.q}</div>`;it.opts.forEach((o,idx)=>{const el=document.createElement('div');el.className='option';el.textContent=o;el.onclick=()=>{if(idx===it.a){el.classList.add('correct');score++;cheer()}else{el.classList.add('wrong');beep('bad')}setTimeout(()=>{i++;$('#bar').style.width=((i)/data.exam.length*100)+'%';if(i<data.exam.length)ask();else box.innerHTML=`<div class='qcard' style='background:#fff9e6;border:1px solid #f3d370'><h3>Finished!</h3><p>Your score: ${score}/${data.exam.length}</p></div>`},480)};card.appendChild(el)});box.appendChild(card)}const prog=document.createElement('div');prog.className='progress';prog.innerHTML='<div id="bar" class="bar"></div>';sec.appendChild(prog);ask()}

function init(){buildTopTabs();[1,2,3,4].forEach(buildLesson);renderExam();activateSection(0)}window.addEventListener('DOMContentLoaded',init)
